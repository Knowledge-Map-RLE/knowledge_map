#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ S3 —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
–°–æ–∑–¥–∞–µ—Ç bucket "markdown" –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª "–ü—Ä–∏–º–µ—Ä —Å—Ç–∞—Ç—å–∏.md".
"""

import asyncio
import logging
from s3_client import get_s3_client

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ markdown —Ñ–∞–π–ª–∞
TEST_MARKDOWN_CONTENT = """# –ü—Ä–∏–º–µ—Ä —Å—Ç–∞—Ç—å–∏ –¥–ª—è Knowledge Map

## –í–≤–µ–¥–µ–Ω–∏–µ

–≠—Ç–æ **–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç–∞—Ç—å—è** –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ S3 —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º NLP –≤ –ø—Ä–æ–µ–∫—Ç–µ Knowledge Map.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

- üìÑ –ó–∞–≥—Ä—É–∑–∫–∞ markdown —Ñ–∞–π–ª–æ–≤ –∏–∑ S3
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ  
- ‚ö° –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- üé® –ö—Ä–∞—Å–∏–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

1. **MinIO S3** - –æ–±—ä–µ–∫—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
2. **FastAPI** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
3. **aioboto3** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π S3 –∫–ª–∏–µ–Ω—Ç
4. **React** - —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

### –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```python
# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –∏–∑ S3
async def load_markdown():
    s3 = get_s3_client()
    content = await s3.download_text("markdown", "example.md")
    return content
```

## –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ NLP

–≠—Ç–æ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- ‚úÖ –ó–∞–≥—Ä—É–∂–∞—Ç—å –±–æ–ª—å—à–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏—Ö —Å –ø–æ–º–æ—â—å—é NLP –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

- **Markdown** (.md) - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç
- **Plain text** (.txt) - –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç
- **JSON** (.json) - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è S3 —Å Knowledge Map –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–º–∞–º–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –∏—Ö –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

---

*–§–∞–π–ª —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–º init_s3_test_data.py*
"""

async def init_s3_test_data():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç S3 —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏."""
    
    logger.info("üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é S3 —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏...")
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º S3 –∫–ª–∏–µ–Ω—Ç
        s3 = get_s3_client()
        logger.info("‚úÖ S3 –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞–µ–º bucket "markdown"
        bucket_exists = await s3.ensure_bucket_exists("markdown")
        if bucket_exists:
            logger.info("‚úÖ Bucket 'markdown' –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é")
        else:
            logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å bucket 'markdown'")
            return False
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
        filename = "–ü—Ä–∏–º–µ—Ä —Å—Ç–∞—Ç—å–∏.md"
        success = await s3.upload_bytes(
            data=TEST_MARKDOWN_CONTENT.encode('utf-8'),
            bucket_name="markdown",
            object_key=filename,
            content_type="text/markdown",
            metadata={
                "created_by": "init_s3_test_data.py",
                "purpose": "nlp_demo",
                "encoding": "utf-8"
            }
        )
        
        if success:
            logger.info(f"‚úÖ –§–∞–π–ª '{filename}' —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ bucket 'markdown'")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å
            downloaded_content = await s3.download_text("markdown", filename)
            if downloaded_content:
                logger.info(f"‚úÖ –§–∞–π–ª '{filename}' —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω ({len(downloaded_content)} —Å–∏–º–≤–æ–ª–æ–≤)")
                return True
            else:
                logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª '{filename}'")
                return False
        else:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª '{filename}'")
            return False
            
    except Exception as e:
        logger.error(f"üí• –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
        return False

async def check_s3_status():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å S3 –∏ –Ω–∞–ª–∏—á–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö."""
    
    logger.info("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å S3...")
    
    try:
        s3 = get_s3_client()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å bucket
        bucket_exists = await s3.ensure_bucket_exists("markdown")
        if not bucket_exists:
            logger.warning("‚ö†Ô∏è Bucket 'markdown' –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
        filename = "–ü—Ä–∏–º–µ—Ä —Å—Ç–∞—Ç—å–∏.md"
        file_exists = await s3.object_exists("markdown", filename)
        
        if file_exists:
            logger.info(f"‚úÖ –§–∞–π–ª '{filename}' –Ω–∞–π–¥–µ–Ω –≤ bucket 'markdown'")
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
            objects = await s3.list_objects("markdown")
            logger.info(f"üìã –§–∞–π–ª–æ–≤ –≤ bucket 'markdown': {len(objects)}")
            for obj in objects:
                logger.info(f"   - {obj['Key']} ({obj['Size']} bytes)")
            
            return True
        else:
            logger.warning(f"‚ö†Ô∏è –§–∞–π–ª '{filename}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ bucket 'markdown'")
            return False
            
    except Exception as e:
        logger.error(f"üí• –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: {e}")
        return False

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è."""
    
    print("=" * 60)
    print("üóÑÔ∏è KNOWLEDGE MAP - –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø S3 –¢–ï–°–¢–û–í–´–ú–ò –î–ê–ù–ù–´–ú–ò")
    print("=" * 60)
    
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
    status_ok = await check_s3_status()
    
    if status_ok:
        logger.info("üéâ S3 —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ!")
        print("\n‚ú® –í—Å—ë –≥–æ—Ç–æ–≤–æ! –ö–æ–º–ø–æ–Ω–µ–Ω—Ç NLP –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.")
        return
    
    # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
    print("\nüîß –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –í—ã–ø–æ–ª–Ω—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...")
    
    success = await init_s3_test_data()
    
    if success:
        print("\nüéâ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
        print("\nüìù –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:")
        print("   ‚úÖ –°–æ–∑–¥–∞–Ω bucket 'markdown'")
        print("   ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª '–ü—Ä–∏–º–µ—Ä —Å—Ç–∞—Ç—å–∏.md'")
        print("   ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö")
        print("\nüåê –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ:")
        print("   - –û—Ç–∫—Ä—ã—Ç—å http://localhost:9001 (MinIO Console)")
        print("   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç NLP –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ")
        print("   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API: GET /api/nlp/markdown/–ü—Ä–∏–º–µ—Ä —Å—Ç–∞—Ç—å–∏.md")
    else:
        print("\nüí• –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏!")
        print("\nüîß –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:")
        print("   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å MinIO: docker-compose restart s3")
        print("   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: docker logs knowledge_map_s3")
        print("   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ—Ä—Ç—ã 9000-9001 —Å–≤–æ–±–æ–¥–Ω—ã")

if __name__ == "__main__":
    asyncio.run(main()) 