<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç –ª–æ–≥–∏–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –±–ª–æ–∫–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .block { display: inline-block; margin: 5px; padding: 10px; border: 1px solid #333; background: #f0f0f0; }
        .pinned { background: #ffeb3b; }
        .current { background: #4caf50; color: white; }
        .result { margin: 10px 0; padding: 10px; background: #e3f2fd; }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç –ª–æ–≥–∏–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤</h1>
    
    <div class="test-section">
        <h3>–¢–µ–∫—É—â–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏</h3>
        <div id="blocks-display"></div>
    </div>
    
    <div class="test-section">
        <h3>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è:</label>
        <select id="block-select"></select>
        <br><br>
        <button onclick="testMove('up')">Ctrl+Up ‚¨ÜÔ∏è</button>
        <button onclick="testMove('down')">Ctrl+Down ‚¨áÔ∏è</button>
        <div id="results"></div>
    </div>

    <script>
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
        function findTargetLevel(currentLevel, direction, excludeBlockId, allBlocks) {
            const pinnedBlocksMap = new Map();
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º (–∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≥—Ä–∞–Ω–∏—Ü)
            allBlocks.forEach(block => {
                if (block.is_pinned && block.id !== excludeBlockId) {
                    const level = block.level;
                    if (!pinnedBlocksMap.has(level)) {
                        pinnedBlocksMap.set(level, []);
                    }
                    pinnedBlocksMap.get(level).push(block.id);
                }
            });
            
            // –ü–æ–ª—É—á–∞–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ —Å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–º–∏ –±–ª–æ–∫–∞–º–∏ (–±–µ–∑ —Ç–µ–∫—É—â–µ–≥–æ)
            const pinnedLevels = Array.from(pinnedBlocksMap.keys()).sort((a, b) => a - b);
            
            console.log(`üîç findTargetLevel: current=${currentLevel}, direction=${direction}, exclude=${excludeBlockId}`);
            console.log(`üìä All pinned levels (excluding current block):`, pinnedLevels);
            
            if (direction === 'up') {
                // "–í–≤–µ—Ä—Ö" –æ–∑–Ω–∞—á–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å —Å –ú–ï–ù–¨–®–ò–ú –Ω–æ–º–µ—Ä–æ–º (–≤–∏–∑—É–∞–ª—å–Ω–æ –≤—ã—à–µ)
                const levelsAbove = pinnedLevels.filter(level => level < currentLevel);
                console.log(`‚¨ÜÔ∏è Levels above ${currentLevel}:`, levelsAbove);
                
                if (levelsAbove.length > 0) {
                    const target = Math.max(...levelsAbove); // –ë–ª–∏–∂–∞–π—à–∏–π (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π) –∏–∑ –º–µ–Ω—å—à–∏—Ö
                    console.log(`‚úÖ Found existing level above: ${target}`);
                    return target;
                }
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (–≤–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π)
                const allLevels = [currentLevel, ...pinnedLevels];
                const minLevel = Math.min(...allLevels);
                const target = minLevel - 1;
                console.log(`üÜï Creating new level above all (including current): ${minLevel} - 1 = ${target}`);
                return target;
            } else {
                // "–í–Ω–∏–∑" –æ–∑–Ω–∞—á–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å —Å –ë–û–õ–¨–®–ò–ú –Ω–æ–º–µ—Ä–æ–º (–≤–∏–∑—É–∞–ª—å–Ω–æ –Ω–∏–∂–µ)
                const levelsBelow = pinnedLevels.filter(level => level > currentLevel);
                console.log(`‚¨áÔ∏è Levels below ${currentLevel}:`, levelsBelow);
                
                if (levelsBelow.length > 0) {
                    const target = Math.min(...levelsBelow); // –ë–ª–∏–∂–∞–π—à–∏–π (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π) –∏–∑ –±–æ–ª—å—à–∏—Ö
                    console.log(`‚úÖ Found existing level below: ${target}`);
                    return target;
                }
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å –Ω–∏–∂–µ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (–≤–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π)
                const allLevels = [currentLevel, ...pinnedLevels];
                const maxLevel = Math.max(...allLevels);
                const target = maxLevel + 1;
                console.log(`üÜï Creating new level below all (including current): ${maxLevel} + 1 = ${target}`);
                return target;
            }
        }

        // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        const blocks = [
            { id: 'block1', level: 1, is_pinned: true, content: '–ë–ª–æ–∫ 1' },
            { id: 'block2', level: 3, is_pinned: true, content: '–ë–ª–æ–∫ 2' },
            { id: 'block3', level: 5, is_pinned: true, content: '–ë–ª–æ–∫ 3' },
            { id: 'block4', level: 7, is_pinned: true, content: '–ë–ª–æ–∫ 4' },
            { id: 'block5', level: 2, is_pinned: false, content: '–ù–µ–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π' },
        ];

        function displayBlocks() {
            const display = document.getElementById('blocks-display');
            const select = document.getElementById('block-select');
            
            display.innerHTML = '';
            select.innerHTML = '';
            
            blocks.filter(b => b.is_pinned).forEach(block => {
                const div = document.createElement('div');
                div.className = 'block pinned';
                div.innerHTML = `${block.content}<br>–£—Ä–æ–≤–µ–Ω—å: ${block.level}`;
                display.appendChild(div);
                
                const option = document.createElement('option');
                option.value = block.id;
                option.textContent = `${block.content} (—É—Ä–æ–≤–µ–Ω—å ${block.level})`;
                select.appendChild(option);
            });
        }

        function testMove(direction) {
            const selectedId = document.getElementById('block-select').value;
            const selectedBlock = blocks.find(b => b.id === selectedId);
            
            if (!selectedBlock) return;
            
            console.clear();
            console.log(`üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –±–ª–æ–∫–∞ ${selectedBlock.content} (—É—Ä–æ–≤–µ–Ω—å ${selectedBlock.level}) –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ ${direction}`);
            
            const targetLevel = findTargetLevel(selectedBlock.level, direction, selectedId, blocks);
            
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="result">
                    <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è:</h4>
                    <p><strong>–ë–ª–æ–∫:</strong> ${selectedBlock.content}</p>
                    <p><strong>–ò—Å—Ö–æ–¥–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å:</strong> ${selectedBlock.level}</p>
                    <p><strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${direction === 'up' ? '–í–≤–µ—Ä—Ö ‚¨ÜÔ∏è' : '–í–Ω–∏–∑ ‚¨áÔ∏è'}</p>
                    <p><strong>–¶–µ–ª–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å:</strong> ${targetLevel}</p>
                    <p><em>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</em></p>
                </div>
            `;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        displayBlocks();
    </script>
</body>
</html> 