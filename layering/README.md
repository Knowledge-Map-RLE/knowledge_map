# Микросервис укладки графа карты знаний

Микросервис для расчета укладки графа карты знаний с использованием gRPC. Сервис принимает граф без координат и возвращает уложенный граф с уровнями, подуровнями и координатами для визуализации.

## Особенности

- Двухпроходный алгоритм оптимизации слоев для направленного ациклического графа (DAG)
- Автоматическое распределение блоков по уровням и подуровням
- Оптимизация расположения для минимизации пересечений
- Поддержка настройки параметров укладки
- Проверка здоровья сервиса
- Подробная статистика результатов укладки

## Требования

- Python 3.9 или выше
- Poetry для управления зависимостями
- gRPC tools для генерации кода из proto-файлов

## Установка

1. Установите Poetry, если еще не установлен:
   ```powershell
   (Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python -
   ```

2. Клонируйте репозиторий и перейдите в директорию микросервиса:
   ```powershell
   cd layering
   ```

3. Установите зависимости с помощью Poetry:
   ```powershell
   poetry install
   ```

4. Сгенерируйте gRPC код из proto-файлов:
   ```powershell
   .\scripts\generate_proto.bat
   ```

## Запуск сервиса

1. Запустите сервис через Poetry:
   ```powershell
   poetry run start-layout-service
   ```

   Или с дополнительными параметрами:
   ```powershell
   poetry run python src/main.py --port 50051 --host 0.0.0.0 --log-level DEBUG
   ```

## Использование

Сервис предоставляет следующие gRPC методы:

### CalculateLayout

Основной метод для расчета укладки графа. Принимает:
- Список блоков с их ID и содержимым
- Список связей между блоками
- Опции укладки (необязательно)

Возвращает:
- Координаты блоков
- Информацию об уровнях и подуровнях
- Статистику укладки

### HealthCheck

Метод для проверки здоровья сервиса.

## Опции укладки

При вызове `CalculateLayout` можно настроить следующие параметры:

- `max_layers` - Максимальное количество слоев
- `max_levels` - Максимальное количество уровней
- `blocks_per_sublevel` - Максимальное количество блоков на подуровень
- `optimize_layout` - Применять ли двухпроходную оптимизацию (по умолчанию true)
- `sublevel_spacing` - Расстояние между подуровнями в пикселях (по умолчанию 200)
- `layer_spacing` - Расстояние между слоями в пикселях (по умолчанию 250)

## Разработка

### Тестирование

Запуск тестов:
```powershell
poetry run pytest
```

### Форматирование кода

```powershell
poetry run black src
poetry run isort src
```

### Проверка типов

```powershell
poetry run mypy src
```

## Структура проекта

```
layering/
├── proto/                  # Proto-файлы с определением gRPC сервиса
├── scripts/               # Скрипты для генерации кода и др.
├── src/                   # Исходный код
│   ├── generated/        # Сгенерированный gRPC код
│   ├── grpc_service.py  # Реализация gRPC сервиса
│   ├── layout_algorithm.py # Алгоритм укладки
│   └── main.py          # Точка входа
├── tests/                 # Тесты
├── pyproject.toml        # Конфигурация Poetry и зависимости
└── README.md             # Документация
```

## Лицензия

MIT 