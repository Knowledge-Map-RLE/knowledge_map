# Алгоритм укладки Карты Знаний

1. Получить направленный граф зависимостей научных статей друго от друга по библиографическим ссылкам.
2. Убрать петли из графа.
3. Убрать повторяющиеся рёбра между одной и тойже парой вершин. Между парой вершин должно быть только одно ребро.
4. Преобразовать граф в направленный ациклический граф (DAG) методом разворота минимального количества рёбер.
    1. Отдельным тестом проверить граф на ацикличность. Если истина, значит алгоритм корректный.
5. Использовать фиктивные вершины (dummy) для укладки связей.
6. Применить к DAG топологическую сортировку. Изолированные вершины должны попасть в конец списка, после всех связанных вершин.
    1. Отдельным тестом проверить алгоритм, является ли полученная топологическая сортировка набором чисел монотонно неубывающей последовательностью целых чисел без пропусков. Если истина, значит алгоритм корректный.
    2. Опционально: включить проверку корректности топологического порядка (настройка `validate_topo_order`). По умолчанию отключена для повышения производительности.
7. Найти 1 длиннейший путь (longest path (LP)) в графе.
8. Назначить узлам длиннейшего пути нулевой уровень (level)
9. Назначить узлам длиннейшего пути слои начиная с нулевого слоя (layer) и назначая следующий слой каждой следующей вершине.
10. Назначить слои всем остальным вершинам, относительно длиннейшего пути, по следующему алгоритму:
    1. Инициализировать карту слоёв, где узлам длиннейшего пути уже назначены слои от 0 до (длина_пути - 1).
    2. Назначить слои всем вершинам в порядке топологической сортировки. Для каждой вершины, если она не обработана:
        1. Найти всех непосредственных предков текущей вершины.
        2. Вычислить максимальный слой среди всех предков: `max_parent_layer = max(слои_всех_предков)`.
        3. Назначить текущей вершине слой равный `max_parent_layer + 1`.
        4. Пометить вершину как обработанную.
    3. Если у вершины нет предков (изолированная вершина), назначить ей слой `-1`.
    4. Опционально: исключить изолированные вершины из укладки (настройка `exclude_isolated_vertices`).
    5. Выполняется на стороне БД батчами по окнам topo_order для повышения производительности.
11. Назначить уровни всем вершинам (кроме уже размещенных LP и закрепленных):
    1. Для каждого слоя собрать все вершины этого слоя.
    2. Отсортировать вершины внутри слоя по топологическому порядку.
    3. Найти занятые позиции (слой, уровень) для LP и закрепленных вершин.
    4. Для каждой вершины в слое найти следующий свободный уровень и назначить его.
    5. Учитывать опцию `exclude_isolated_vertices` - не назначать уровни изолированным вершинам, если опция включена.
    6. Каждый слой обрабатывается независимо с собственным счетчиком уровней.
    7. Обновление координат и уровней выполняется батчами в БД для оптимизации производительности.


- Визуальный блок или просто "блок" это графическое отображение вершин при визуализации с шириной, высотой, надписью и координатами.
- Блокам присваиваются координаты по оси x на основе его слоя, учитывая ширину блока и горизонтальный отступ от блоков соседних слоёв.
- Блокам присваиваются координаты по оси y на основе его уровня, учитывая высоту визуального блока и вертикальный отступ от блоков соседних уровней.
- Таким образом граф укладывается слева направо, где по горизонтали распределяются слои, а по вертикали уровни.
- На одном слое может находиться неограниченное количество вершин.
- Уровни и слои могут быть отрицательными.
- Закреплённые вершины сохраняют назначенные им уровни при переукладке, но могут менять слой.
- Место это уникальная пара слой и уровень.
- На одном месте может находиться только одна вершина.
- Если в данной статье есть библиографические ссылки, то нужно принять их так же за статьи, а также за хронологически более старые статьи. А данную статью за хронологически более новую относительно них. Таким образом граф должен топологически укладываться слева направо единым однонаправленным DAG потоком, где слева более старые, а справа более новые научные статьи.

Каких шагов не должно быть, они нам не нужны:
- Минимизация пересечений рёбер